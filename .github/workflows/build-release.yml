name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        include:
          - platform: 'macos-latest'
            target: 'aarch64-apple-darwin'
            bundle: 'dmg'
          - platform: 'macos-latest'
            target: 'x86_64-apple-darwin'
            bundle: 'dmg'
          - platform: 'windows-latest'
            target: 'x86_64-pc-windows-msvc'
            bundle: 'msi'

    runs-on: ${{ matrix.platform }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: silk-spool/package-lock.json

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install dependencies (Ubuntu only)
      if: matrix.platform == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev webkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

    - name: Install frontend dependencies
      run: |
        cd silk-spool
        npm ci

    - name: Build frontend
      run: |
        cd silk-spool
        npm run build

    - name: Build Tauri app
      uses: tauri-apps/tauri-action@v0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tagName: ${{ github.ref_name }}
        releaseName: 'Silk Spool ${{ github.ref_name }}'
        releaseBody: |
          ## 🎉 Silk Spool ${{ github.ref_name }} - Beta Release
          
          This is a beta release of Silk Spool, a beautiful mod manager for Hollow Knight: Silksong!
          
          ### ✨ Key Features
          - **🎮 Automatic Setup**: Smart detection of Hollow Knight: Silksong and BepInEx installations
          - **📚 Mod Discovery**: Browse mods from multiple repositories with advanced search and filtering
          - **🔧 Complete Mod Management**: One-click installation and uninstallation with progress tracking
          - **🎨 Beautiful Interface**: Dark theme with responsive design
          - **🔔 Real-time Updates**: Live UI updates when mods are installed/uninstalled
          - **📱 Cross-platform**: Works on Windows and macOS
          
          ### 📋 System Requirements
          - **macOS**: macOS 10.15+ (ARM64 or Intel)
          - **Windows**: Windows 10+ (x64)
          - **Hollow Knight: Silksong**: Steam installation
          - **BepInEx**: Will be detected automatically
          
          ### 🐛 Known Issues
          - Some download hosts may require manual intervention
          - First launch may take longer due to initial setup
          - Some mods may require additional dependencies
          
          ### 🤝 Feedback
          This is a beta release! Please report any issues or suggestions on GitHub Issues.
          
          **Thank you for trying Silk Spool!** 🎮✨
        releaseDraft: true
        prerelease: true
        includeDebug: false
        includeSource: false
        workingDirectory: silk-spool
